<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Playing 11</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f2f4f8;padding:20px}
.box{background:#fff;padding:16px;border-radius:12px;max-width:420px;margin:auto}
select,button{width:100%;padding:12px;margin:8px 0;font-size:16px}
.player{display:flex;align-items:center;gap:8px;font-size:14px;padding:8px 0;border-bottom:1px solid #eee}
.head{font-size:12px;color:#555;width:50px;text-align:center}
.count{font-size:13px;color:#777;margin:6px 0;text-align:right}
button{background:#0a7cff;color:#fff;border:none;border-radius:8px}
</style>
</head>
<body>

<div class="box">
<h2>Select Playing 11 + Subs</h2>

<label><b>Select Team</b></label>
<select id="teamSelect" onchange="loadPlayers()"></select>

<div class="count" id="count">0 selected</div>

<div style="display:flex;font-size:12px;color:#555;margin-top:6px">
<div class="head">PLAY</div>
<div class="head">CAP</div>
<div class="head">WK</div>
<div class="head">SUB</div>
<div style="flex:1"></div>
</div>

<div id="players"></div>

<button onclick="saveSquad()">SAVE SQUAD</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwoc84x0cmXWJ6GHzEae4kTJCMdEyvlK7NKq7m12oE6getykgU0UuUUpc37LZcoCuI/exec";
const MATCH_ID="MATCH_1768624533546";

function loadTeams(){
fetch(`${API}?action=getTeams`)
.then(r=>r.json())
.then(d=>{
let html=`<option value="">-- Select Team --</option>`;
d.teams.forEach(t=>{
html+=`<option value="${t.teamId}">${t.teamName}</option>`;
});
teamSelect.innerHTML=html;
});
}

function loadPlayers(){
const teamId=teamSelect.value;
if(!teamId){ players.innerHTML=""; return; }

fetch(`${API}?action=getPlayers&teamId=${teamId}`)
.then(r=>r.json())
.then(d=>{
players.innerHTML="";
d.players.forEach(p=>{
players.innerHTML+=`
<div class="player">
<input type="checkbox" class="play" value="${p.playerId}" onchange="updateCount()">
<input type="radio" name="captain" value="${p.playerId}">
<input type="radio" name="keeper" value="${p.playerId}">
<input type="checkbox" class="sub" value="${p.playerId}" onchange="syncSub(this)">
<span>${p.playerName}</span>
</div>`;
});
updateCount();
});
}

const playBox = document.querySelector(`.play[value="${p.playerId}"]`);
const subBox  = document.querySelector(`.sub[value="${p.playerId}"]`);

playBox.addEventListener("change", () => {
  if (playBox.checked) subBox.checked = false;
});

function updateCount(){
const n=document.querySelectorAll(".play:checked").length;
count.innerText=`${n} selected`;
}

function syncSub(cb){
const playBox = document.querySelector(`.play[value="${cb.value}"]`);
if(!playBox.checked){
cb.checked=false;
alert("Substitute must be from selected players");
}
}

function saveSquad(){
const teamId=teamSelect.value;
const playing=[...document.querySelectorAll(".play:checked")];
const subs=[...document.querySelectorAll(".sub:checked")];

if(playing.length < 11) return alert("Minimum 11 players required");
if(playing.length > 14) return alert("Maximum 14 allowed");

const extra = playing.length - 11;

if(extra === 0 && subs.length === 0){
if(!confirm("No substitutes selected. Continue?")) return;
}

if(extra > 0 && subs.length !== extra){
return alert(`Select ${extra} Substitute players`);
}

const captain=document.querySelector("input[name=captain]:checked")?.value||"";
const keeper=document.querySelector("input[name=keeper]:checked")?.value||"";

if(!playing.find(p=>p.value===captain)) return alert("Captain must be from playing");
if(!playing.find(p=>p.value===keeper)) return alert("Keeper must be from playing");

const data=[];

playing.forEach(p=>{
data.push({
playerId:p.value,
role:"PLAYING",
isCaptain:p.value===captain,
isKeeper:p.value===keeper,
isPlaying:true,
isSubstitute:false
});
});

subs.forEach(p => {
  if (!playing.find(pl => pl.value === p.value)) {
    data.push({
      playerId: p.value,
      role: "SUBSTITUTE",
      isCaptain: false,
      isKeeper: false,
      isPlaying: false,
      isSubstitute: true
    });
  }
});

fetch(`${API}?action=savePlaying11&matchId=${MATCH_ID}&teamId=${teamId}&players=${encodeURIComponent(JSON.stringify(data))}`)
.then(r=>r.json())
.then(()=>alert("Squad Saved âœ…"));
}

loadTeams();
</script>
</body>
</html>
